<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CJ6Q3HP3K5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-CJ6Q3HP3K5'); // <-- Replace with your Measurement ID
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A/B Test Analyzer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <style>
        /* --- Global Styles & Variables --- */
        :root { /* Light mode */ --bg-color:#f4f7f9;--card-bg:#ffffff;--text-color:#333a4d;--heading-color:#2c3e50;--primary-color:#367bf5;--primary-gradient:linear-gradient(90deg,#4e8ff7 0%,#367bf5 100%);--accent-color:#f39c12;--border-color:#e3e8ee;--shadow-color:rgba(149,157,165,0.1);--header-bg:linear-gradient(90deg,#4a7efd 0%,#356ae6 100%);--header-text:#ffffff;--success-color:#27ae60;--error-color:#e74c3c;--info-color:#3498db;--font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;--conclusion-bg:#eef2f7;--conclusion-card-bg:#ffffff;--conclusion-card-border:var(--primary-color); }
        body.dark-mode { /* Dark mode */ --bg-color:#1e293b;--card-bg:#2d3748;--text-color:#cbd5e0;--heading-color:#e2e8f0;--primary-color:#367bf5;--primary-gradient:linear-gradient(90deg,#4e8ff7 0%,#367bf5 100%);--accent-color:#f39c12;--border-color:#4a5568;--shadow-color:rgba(0,0,0,0.2);--header-bg:linear-gradient(90deg,#2c3e50 0%,#1a202c 100%);--header-text:#ffffff;--success-color:#27ae60;--error-color:#e74c3c;--info-color:#3498db;--conclusion-bg:#3b4a5f;--conclusion-card-bg:var(--card-bg);--conclusion-card-border:var(--primary-color); }
        * { box-sizing:border-box; margin:0; padding:0; } html { height:100%; } body { font-family:var(--font-family); line-height:1.6; color:var(--text-color); background-color:var(--bg-color); transition:background-color 0.3s,color 0.3s; min-height:100%; display:flex; flex-direction:column; }
        .container { flex-grow:1; display:flex; flex-wrap:wrap; gap:30px; max-width:1300px; margin:30px auto 0 auto; padding:0 15px; width:100%; }
        /* Header Styles */ .app-header { background:var(--header-bg); color:var(--header-text); padding:15px 30px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); position:sticky; top:0; z-index:100; } .app-header h1 { font-size:1.5rem; font-weight:600; } .app-header h1 i { margin-right:10px; } .app-header h1 span { font-size:0.9rem; font-weight:300; opacity:0.8; margin-left:10px; } .theme-toggle { background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3); color:var(--header-text); padding:8px 12px; border-radius:20px; cursor:pointer; font-size:0.9rem; transition:background-color 0.2s; } .theme-toggle:hover { background:rgba(255,255,255,0.3); } .theme-toggle i { margin-right:5px; } body.dark-mode .theme-toggle .fa-moon { display:none; } body:not(.dark-mode) .theme-toggle .fa-sun { display:none; }
        /* Layout Styles */ .column { flex:1; display:flex; flex-direction:column; gap:25px; min-width:350px; margin-bottom:30px; } .left-column { flex-basis:400px; flex-grow:0; flex-shrink:0; } .right-column { flex-grow:1; }
        /* Panel Styles */ .panel { background-color:var(--card-bg); padding:25px; border-radius:8px; border:1px solid var(--border-color); box-shadow:0 3px 8px var(--shadow-color); transition:background-color 0.3s,border-color 0.3s; } .panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid var(--border-color); } .panel-header h2 { color:var(--heading-color); font-size:1.15rem; font-weight:600; transition:color 0.3s; } .panel-header h2 i { margin-right:8px; color:var(--primary-color); }
        /* Input Styles (Mostly unchanged) */ .variants-container { display:flex; gap:20px; margin-bottom:20px; } .variant-input { flex:1; } .variant-input h3 { font-size:1rem; font-weight:600; margin-bottom:12px; } #variant-a-title { color:var(--info-color); } #variant-b-title { color:var(--accent-color); } .input-group { margin-bottom:15px; } .input-group:last-child { margin-bottom:0; } .input-group label { display:block; margin-bottom:5px; font-size:0.9rem; font-weight:500; color:var(--text-color); } .input-group input[type="number"],.input-group select { width:100%; padding:10px; border:1px solid var(--border-color); border-radius:4px; font-size:0.95rem; background-color:var(--bg-color); color:var(--text-color); appearance:none; background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position:right 0.5rem center; background-repeat:no-repeat; background-size:1.5em 1.5em; padding-right:2.5rem; } .input-group input[type="number"]:focus,.input-group select:focus { outline:none; border-color:var(--primary-color); box-shadow:0 0 0 2px rgba(54,123,245,0.2); } body.dark-mode .input-group select { background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23cbd5e0' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); } .radio-group label { display:inline-block; margin-left:5px; margin-right:15px; font-weight:normal; font-size:0.9rem; cursor:pointer; } .radio-group input[type="radio"] { margin-right:3px; cursor:pointer; accent-color:var(--primary-color); } .config-container { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:25px; } .config-group { display:flex; align-items:center; gap:10px; } .config-group label { margin-bottom:0; flex-shrink:0; } .config-group select { width:auto; flex-grow:1; min-width:100px; } #calculateButton { display:block; width:100%; padding:12px; font-size:1.05rem; font-weight:600; color:white; background:var(--primary-gradient); border:none; border-radius:6px; cursor:pointer; transition:all 0.3s ease; text-align:center; margin-top:5px; } #calculateButton:hover { opacity:0.9; box-shadow:0 4px 10px rgba(54,123,245,0.3); } #calculateButton:disabled { background:grey; cursor:not-allowed; box-shadow:none; opacity:0.7; } #calculateButton i { margin-right:8px; }
        /* History Styles */ #clearHistoryButton { background:none; border:none; color:var(--error-color); cursor:pointer; font-size:0.9rem; font-weight:500; } #clearHistoryButton:hover { text-decoration:underline; } #clearHistoryButton i { margin-right:4px; } #recent-tests-list { list-style:none; padding:0; max-height:250px; overflow-y:auto; margin-top:15px; } #recent-tests-list li { border:1px solid var(--border-color); border-radius:4px; padding:10px 12px; margin-bottom:10px; font-size:0.85rem; background-color:var(--bg-color); position:relative; display:flex; flex-direction:column; gap:4px; } .history-item-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:3px; } .history-item-header strong { font-weight:600; color:var(--heading-color); } .history-item-details { font-size:0.8rem; opacity:0.9; } .history-item-details .test-type { font-style:italic; opacity:0.8; } .history-item-inputs { background-color:var(--border-color); color:var(--text-color); padding:2px 6px; border-radius:3px; font-size:0.75rem; display:inline-block; align-self:flex-start; margin-top:3px; } body.dark-mode .history-item-inputs { background-color:#4a5568; }
        /* UPDATED/NEW: Results Panel Styling */ .results-section { margin-bottom:25px; padding-bottom:20px; border-bottom:1px dashed var(--border-color); } .results-section:last-child { margin-bottom:0; padding-bottom:0; border-bottom:none; } .results-section h3 { font-size:1.1rem; color:var(--heading-color); margin-bottom:15px; font-weight:600; } .results-section h3 i { margin-right:8px; width:1.2em; }
        /* Input Summary Specific Styles */ #summary-results h3 i { color: #2980b9; } .summary-container { display: flex; gap: 20px; flex-wrap: wrap; } .summary-box { flex: 1; min-width: 200px; border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; background-color: var(--bg-color); border-left-width: 4px; } .summary-box.variant-a { border-left-color: var(--info-color); } .summary-box.variant-b { border-left-color: var(--accent-color); } .summary-box h4 { font-size: 1rem; font-weight: 600; margin-bottom: 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; } .summary-box.variant-a h4 { color: var(--info-color); } .summary-box.variant-b h4 { color: var(--accent-color); } .summary-stat { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; } .summary-stat-label { display: flex; align-items: center; opacity: 0.9; } .summary-stat-label i { margin-right: 6px; width: 1.1em; opacity: 0.7;} .summary-stat-value { font-weight: 600; color: var(--heading-color); } .summary-cr { font-size: 1.2rem; font-weight: 700; margin-top: 10px; text-align: right; } .summary-cr .cr-label { font-size: 0.8em; font-weight: normal; opacity: 0.8; display: block;}
        /* Frequentist Analysis Specific Styles */ #frequentist-results h3 i { color: var(--accent-color); } .result-item { display: flex; align-items: flex-start; margin-bottom: 12px; font-size: 0.95rem; } .result-item strong { font-weight: 500; min-width: 190px; display: inline-flex; align-items: center; margin-right: 10px; color: var(--heading-color) } .result-item strong i { margin-right: 8px; width: 1.2em; opacity: 0.7; color: var(--text-color); } #zScore, #pValue { font-weight: bold; font-family: monospace; background-color: rgba(128, 128, 128, 0.08); padding: 1px 5px; border-radius: 3px; } body.dark-mode #zScore, body.dark-mode #pValue { background-color: rgba(255, 255, 255, 0.08); } .result-value-container { flex-grow: 1; } #sig-interpretation { font-size:0.85rem; font-style:italic; opacity:0.8; display:block; padding-left: 0px; margin-top: 4px; } .badge { display: inline-block; padding: 3px 9px; font-size: 0.85rem; font-weight: 600; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem; color: #fff; } .badge.success { background-color: var(--success-color); } .badge.error { background-color: var(--error-color); } .badge.na { background-color: #6c757d; }
        /* Bayesian & Chart Styles (Unchanged) */ #bayesian-results h3 i { color:var(--primary-color); } #probBbeatsAValue { font-size:2.2rem; font-weight:700; color:var(--primary-color); display:block; margin-top:5px; } .chart-container { margin-top:20px; position:relative; max-width:100%; min-height:150px; background-color:var(--bg-color); border:1px dashed var(--border-color); border-radius:4px; padding:10px; } #betaChart { max-height:250px; width:100% !important; display:block; }
        /* Inference Styles (with corrected .math style) */ #inference-section h3 { display:none; } #inference-section h4 { color:var(--heading-color); font-size:1.05rem; margin-top:20px; margin-bottom:8px; } #inference-section h4:first-child { margin-top:0; } #inferenceText { font-size:0.95rem; color:var(--text-color); margin-top:10px; } .inference-summary-card { background-color:var(--conclusion-card-bg); border:1px solid var(--border-color); border-left:5px solid var(--conclusion-card-border); padding:20px 25px; border-radius:8px; margin-bottom:25px; box-shadow:0 2px 5px var(--shadow-color); } .inference-summary-card h4 { font-size:1.2rem; color:var(--heading-color); margin:0 0 10px 0; display:flex; align-items:center; } .inference-summary-card h4 i { margin-right:10px; color:var(--conclusion-card-border); font-size:1.3rem; } .inference-summary-card p { margin-bottom:0; font-size:1rem; font-weight:500; line-height:1.7; } .inference-details { background-color:var(--conclusion-bg); border:1px solid var(--border-color); padding:15px 20px; border-radius:6px; font-size:0.95rem; } .inference-details h4 { color:var(--heading-color); font-size:1.05rem; margin-top:15px; margin-bottom:8px; } .inference-details h4:first-child { margin-top:0; } .inference-details p { margin-bottom:12px; opacity:0.95; } .inference-details strong { font-weight:600; } .inference-details .math { font-family:monospace; font-size:0.9em; background-color:rgba(189, 195, 199, 0.3); padding:2px 5px; border-radius:4px; display:inline-block; line-height:1.2; } body.dark-mode .inference-details .math { background-color:rgba(93, 109, 126, 0.4); }
        /* Utility Styles */ #errorMessages { color:var(--error-color); background-color:rgba(231,76,60,0.1); border:1px solid var(--error-color); padding:10px 15px; border-radius:4px; margin-bottom:15px; font-size:0.9rem; display:none; } #errorMessages ul { margin-left:20px; } #chartErrorMsg { color: var(--error-color); font-size: 0.9em; text-align: center; display: none; margin-top: 10px;}
        /* Footer Styles */ footer { width:100%; padding:20px 15px; margin-top:30px; text-align:center; font-size:0.9rem; color:var(--text-color); opacity:0.7; border-top:1px solid var(--border-color); background-color:var(--card-bg); transition:background-color 0.3s,color 0.3s,border-color 0.3s; } footer .heart { color:var(--error-color); display:inline-block; margin:0 2px; animation:pulse 1.5s infinite ease-in-out; } @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.1);} 100%{transform:scale(1);} }
        /* Responsive Styles */ @media (max-width:992px) { .container { flex-direction:column; } .left-column { flex-basis:auto; flex-grow:1; width:100%; } .summary-container { gap: 15px;} } @media (max-width:768px) { .app-header { padding:10px 15px; } .app-header h1 { font-size:1.2rem; } .variants-container { flex-direction:column; gap:10px; } .config-container { flex-direction:column; gap:15px; } .column { min-width:300px; margin-bottom:15px; } #probBbeatsAValue { font-size:1.8rem; } .panel { padding:20px; } footer {margin-top: 15px;} .summary-box { min-width: 100%; } }
    </style>
</head>
<body>
    <header class="app-header"> <h1><i class="fa-solid fa-scale-balanced"></i> A/B Test Analyzer <span>(beta)</span></h1> <button class="theme-toggle" id="themeToggle"> <i class="fa-solid fa-moon"></i><i class="fa-solid fa-sun"></i> Dark Mode </button> </header>

    <div class="container">
        <!-- Left Column -->
        <div class="column left-column">
            <!-- Input Panel -->
             <div class="panel" id="input-panel"> <div class="panel-header"> <h2><i class="fa-solid fa-keyboard"></i> Input Data</h2> </div> <div id="errorMessages"></div> <div class="variants-container"> <div class="variant-input"> <h3 id="variant-a-title">Variant A (Control)</h3> <div class="input-group"> <label for="visitorsA">Users:</label> <input type="number" id="visitorsA" value="1000" min="0"> </div> <div class="input-group"> <label for="conversionsA">Conv:</label> <input type="number" id="conversionsA" value="100" min="0"> </div> </div> <div class="variant-input"> <h3 id="variant-b-title">Variant B</h3> <div class="input-group"> <label for="visitorsB">Users:</label> <input type="number" id="visitorsB" value="1000" min="0"> </div> <div class="input-group"> <label for="conversionsB">Conv:</label> <input type="number" id="conversionsB" value="120" min="0"> </div> </div> </div>
                <div class="config-container">
                    <div class="input-group config-group"> <label for="significanceLevel">Significance Level (α):</label> <select id="significanceLevel"> <option value="0.1">0.10 (90% Confidence)</option> <option value="0.05" selected>0.05 (95% Confidence)</option> <option value="0.01">0.01 (99% Confidence)</option> <option value="0.001">0.001 (99.9% Confidence)</option> </select> </div>
                    <div class="input-group config-group radio-group"> <label>Test Type:</label> <input type="radio" id="twoTailed" name="testType" value="two-tailed" checked> <label for="twoTailed">Two-tailed</label> <input type="radio" id="oneTailed" name="testType" value="one-tailed-B>A"> <label for="oneTailed">One-tailed (B>A)</label> </div>
                 </div>
                 <button id="calculateButton"><i class="fa-solid fa-calculator"></i> Run Analysis</button>
            </div>
             <!-- History Panel -->
            <div class="panel" id="history-panel"> <div class="panel-header"> <h2><i class="fa-solid fa-clock-rotate-left"></i> Recent Tests</h2> <button id="clearHistoryButton"><i class="fa-solid fa-trash-can"></i> Clear</button> </div> <ul id="recent-tests-list"></ul> <div id="no-history" style="text-align: center; color: #777; font-style:italic; margin-top: 15px; display: none;">No past tests recorded.</div> </div>
        </div>

        <!-- Right Column -->
        <div class="column right-column">
            <!-- Results Panel -->
            <div class="panel" id="results-panel"> <div class="panel-header"> <h2><i class="fa-solid fa-chart-line"></i> Analysis Results</h2> </div>
                 <div id="resultsContent" style="display: none;">
                     <div class="results-section" id="summary-results"> <h3><i class="fa-solid fa-list-ol"></i> Inputs Summary</h3> <div class="summary-container"> <div class="summary-box variant-a"> <h4>Variant A (Control)</h4> <div class="summary-stat"> <span class="summary-stat-label"><i class="fa-solid fa-users"></i> Users:</span> <span class="summary-stat-value" id="summaryUsersA">---</span> </div> <div class="summary-stat"> <span class="summary-stat-label"><i class="fa-solid fa-check-to-slot"></i> Conversions:</span> <span class="summary-stat-value" id="summaryConvAVal">---</span> </div> <div class="summary-cr"> <span class="cr-label">Conversion Rate</span> <span id="crAVal">--.--%</span> </div> </div> <div class="summary-box variant-b"> <h4>Variant B</h4> <div class="summary-stat"> <span class="summary-stat-label"><i class="fa-solid fa-users"></i> Users:</span> <span class="summary-stat-value" id="summaryUsersB">---</span> </div> <div class="summary-stat"> <span class="summary-stat-label"><i class="fa-solid fa-check-to-slot"></i> Conversions:</span> <span class="summary-stat-value" id="summaryConvBVal">---</span> </div> <div class="summary-cr"> <span class="cr-label">Conversion Rate</span> <span id="crBVal">--.--%</span> </div> </div> </div> </div>
                     <div class="results-section" id="frequentist-results"> <h3><i class="fa-solid fa-flask-vial"></i> Frequentist Analysis</h3> <div class="result-item"> <strong><i class="fa-solid fa-flag-checkered"></i>Test Type:</strong> <div class="result-value-container"> <span class="result-value" id="testTypeDisplay">---</span> </div> </div> <div class="result-item"> <strong><i class="fa-solid fa-bullseye"></i>Significance Level (α):</strong> <div class="result-value-container"> <span class="result-value" id="alphaValue">---</span> </div> </div> <div class="result-item"> <strong><i class="fa-solid fa-calculator"></i>Z-score:</strong> <div class="result-value-container"> <span class="result-value" id="zScore">---</span> </div> </div> <div class="result-item"> <strong><i class="fa-solid fa-dice"></i>P-value:</strong> <div class="result-value-container"> <span class="result-value" id="pValue">---</span> </div> </div> <div class="result-item"> <strong><i class="fa-solid fa-clipboard-check"></i>Stat. Significance:</strong> <div class="result-value-container"> <span class="result-value" id="significanceBadge">---</span> <span id="sig-interpretation">Select inputs and run analysis.</span> </div> </div> </div>
                     <div class="results-section" id="bayesian-results"> <h3><i class="fa-solid fa-brain"></i> Bayesian Analysis</h3> <div class="result-item"><strong>Prior Assumption:</strong> <div class="result-value-container"><span class="result-value">Uniform (Beta(1, 1))</span></div></div> <div class="result-item"><strong>Probability B > A:</strong> <div class="result-value-container"><span class="result-value" id="probBbeatsAValue">---</span></div></div> <div class="result-item"><strong>Posterior Distributions:</strong></div> <div class="chart-container"> <canvas id="betaChart"></canvas> <div id="chartErrorMsg" style="color: var(--error-color); font-size: 0.9em; text-align: center; display: none; margin-top: 10px;">Chart could not be rendered. Check console for details.</div> </div> </div>
                     <div class="results-section" id="inference-section"> <div id="inferenceText"> Please run the analysis to generate the inference. </div> </div>
                </div>
                <div id="resultsPlaceholder" style="text-align: center; padding: 40px 0; color: #777; font-style:italic;"> Enter data and click "Run Analysis" to see the results. </div>
            </div>
        </div>
    </div>

    <footer> Made with <span class="heart">♥</span> by Subh </footer>

    <script>
        // --- DOM Refs ---
        const visitorsAInput=document.getElementById('visitorsA'); const conversionsAInput=document.getElementById('conversionsA'); const visitorsBInput=document.getElementById('visitorsB'); const conversionsBInput=document.getElementById('conversionsB'); const significanceLevelInput=document.getElementById('significanceLevel'); const calculateButton=document.getElementById('calculateButton'); const errorMessagesDiv=document.getElementById('errorMessages'); const resultsContentDiv=document.getElementById('resultsContent'); const resultsPlaceholderDiv=document.getElementById('resultsPlaceholder'); const summaryUsersA=document.getElementById('summaryUsersA'); const summaryConvAVal=document.getElementById('summaryConvAVal'); const crAVal=document.getElementById('crAVal'); const summaryUsersB=document.getElementById('summaryUsersB'); const summaryConvBVal=document.getElementById('summaryConvBVal'); const crBVal=document.getElementById('crBVal'); const testTypeDisplayEl = document.getElementById('testTypeDisplay'); const alphaValueEl=document.getElementById('alphaValue'); const zScoreEl=document.getElementById('zScore'); const pValueEl=document.getElementById('pValue'); const significanceBadgeEl=document.getElementById('significanceBadge'); const sigInterpretationEl=document.getElementById('sig-interpretation'); const probBbeatsAValueEl=document.getElementById('probBbeatsAValue'); const betaChartCanvas=document.getElementById('betaChart'); const chartErrorMsgEl = document.getElementById('chartErrorMsg'); const inferenceTextEl=document.getElementById('inferenceText'); const recentTestsList=document.getElementById('recent-tests-list'); const clearHistoryButton=document.getElementById('clearHistoryButton'); const noHistoryMsg=document.getElementById('no-history'); const themeToggleButton=document.getElementById('themeToggle'); let betaChartInstance=null;
        // --- Math Helpers ---
        function standardNormalCDF(x) { const b1=0.319381530, b2=-0.356563782, b3=1.781477937, b4=-1.821255978, b5=1.330274429, p=0.2316419, c2=0.3989423; if(x>=0.0){const t=1.0/(1.0+p*x); return (1.0-c2*Math.exp(-x*x/2.0)*t*(t*(t*(t*(t*b5+b4)+b3)+b2)+b1));} else {const t=1.0/(1.0-p*x); return (c2*Math.exp(-x*x/2.0)*t*(t*(t*(t*(t*b5+b4)+b3)+b2)+b1));} }
        function randomNormal() { let u=0, v=0; while(u===0)u=Math.random(); while(v===0)v=Math.random(); return Math.sqrt(-2.0*Math.log(u))*Math.cos(2.0*Math.PI*v); }
        function logGamma(Z) { const S=[1.000000000190015,76.18009172947146,-86.50532032941677,24.01409824083091,-1.231739572450155,0.1208650973866179e-2,-0.5395239384953e-5];var T=Z+5.5;T-=(Z+.5)*Math.log(T);var N=0;for(var M=1;M<S.length;M++)N+=S[M]/(Z+M-1); const val=T+Math.log(2.5066282746310005*N/Z); return isFinite(val)?val:Number.MAX_VALUE; }
        function betaPDF(x, a, b) { if (!isFinite(a)||!isFinite(b)||a<=0||b<=0) return 0; const e=1e-15; x=Math.max(e,Math.min(1-e,x)); if (x<=0||x>=1) return 0; if (a>500||b>500){ const m=a/(a+b); const v=(a*b)/(Math.pow(a+b,2)*(a+b+1)); if(v<=0)return 0; const s=Math.sqrt(v); const z=(x-m)/s; const n=Math.exp(-0.5*z*z)/Math.sqrt(2*Math.PI); return n/s;} const lgA=logGamma(a);const lgB=logGamma(b);const lgAB=logGamma(a+b); if(!isFinite(lgA)||!isFinite(lgB)||!isFinite(lgAB)){return 0;} const lnX=Math.log(x); const ln1mX=Math.log(1-x); if(!isFinite(lnX)||!isFinite(ln1mX)) return 0; const lnN=(a-1)*lnX+(b-1)*ln1mX; const lnD=lgA+lgB-lgAB; const r=Math.exp(lnN-lnD); return isFinite(r)?r:0;}
        function gammaSample(shape, scale=1) { if(shape<=0)return NaN;if(shape<1){try{const U=Math.random();return gammaSample(shape+1,scale)*Math.pow(U,1.0/shape);}catch{return NaN;}} const d=shape-1.0/3.0,c=1.0/Math.sqrt(9.0*d);let x,v;while(true){x=randomNormal();v=1.0+c*x;if(v<=0)continue;v=v*v*v;const u=Math.random();if(u<1.0-0.0331*(x*x)*(x*x))return d*v*scale;try{if(Math.log(u)<0.5*x*x+d*(1.0-v+Math.log(v)))return d*v*scale;}catch{return NaN;}} }
        function betaSample(alpha, beta) { const G1=gammaSample(alpha,1); const G2=gammaSample(beta,1); if(isNaN(G1)||isNaN(G2)||(G1+G2===0)){return alpha/(alpha+beta);} return G1/(G1+G2); }
        // --- Main Calculation ---
        function runAnalysis() { calculateButton.disabled=true; calculateButton.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Calculating...'; errorMessagesDiv.style.display='none'; errorMessagesDiv.innerHTML=''; resultsContentDiv.style.display='none'; resultsPlaceholderDiv.style.display='block'; resultsPlaceholderDiv.textContent='Calculating...'; inferenceTextEl.innerHTML='Calculating...'; chartErrorMsgEl.style.display='none'; if(betaChartInstance){betaChartInstance.destroy();betaChartInstance=null;} const visitorsA=parseInt(visitorsAInput.value); const conversionsA=parseInt(conversionsAInput.value); const visitorsB=parseInt(visitorsBInput.value); const conversionsB=parseInt(conversionsBInput.value); const alphaLevel=parseFloat(significanceLevelInput.value); const testType=document.querySelector('input[name="testType"]:checked').value; let errors=[]; if(!Number.isInteger(visitorsA)||!Number.isInteger(conversionsA)||!Number.isInteger(visitorsB)||!Number.isInteger(conversionsB))errors.push("Inputs must be whole numbers.");else{if(visitorsA<=0||visitorsB<=0)errors.push("Visitor numbers > 0.");if(conversionsA<0||conversionsB<0)errors.push("Conversions >= 0.");if(conversionsA>visitorsA)errors.push("A conv <= A visitors.");if(conversionsB>visitorsB)errors.push("B conv <= B visitors.");} if(isNaN(alphaLevel)||alphaLevel<=0||alphaLevel>=1)errors.push("Invalid Significance Level (α)."); if(!testType)errors.push("Select a Test Type."); if(errors.length>0){errorMessagesDiv.innerHTML='<ul>'+errors.map(e=>`<li>${e}</li>`).join('')+'</ul>';errorMessagesDiv.style.display='block';resetCalculatorButton();resultsPlaceholderDiv.textContent='Invalid inputs.';inferenceTextEl.innerHTML='Could not generate inference due to input errors.';return;}
            
            // ===================================================================
            // GOOGLE ANALYTICS EVENT - ADDED HERE
            // This sends a custom event after input validation passes.
            // ===================================================================
            if (typeof gtag === 'function') {
                gtag('event', 'run_analysis', {
                    'event_category': 'calculator',
                    'event_label': 'Successful A/B Calculation',
                    'test_type': testType 
                });
            }
            // ===================================================================

            resultsContentDiv.style.display='block'; resultsPlaceholderDiv.style.display='none'; const crNumA = visitorsA > 0 ? conversionsA / visitorsA : 0; const crNumB = visitorsB > 0 ? conversionsB / visitorsB : 0; summaryUsersA.textContent=visitorsA.toLocaleString(); summaryConvAVal.textContent=conversionsA.toLocaleString(); crAVal.textContent=(crNumA*100).toFixed(2)+'%'; summaryUsersB.textContent=visitorsB.toLocaleString(); summaryConvBVal.textContent=conversionsB.toLocaleString(); crBVal.textContent=(crNumB*100).toFixed(2)+'%'; const pPooled=(conversionsA+conversionsB)/(visitorsA+visitorsB); const se=Math.sqrt(pPooled*(1-pPooled)*(1/visitorsA + 1/visitorsB)); let zScore=0; if(se>0){zScore=(crNumB-crNumA)/se;}else if(crNumB !== crNumA){zScore=(crNumB>crNumA)?Infinity:-Infinity;} let pValue=NaN; if(isFinite(zScore)){if(testType==='two-tailed'){pValue=2*(1-standardNormalCDF(Math.abs(zScore)));}else{pValue=1-standardNormalCDF(zScore);}}else if(crNumB !== crNumA){pValue=(testType==='one-tailed-B>A'&&zScore>0)||testType==='two-tailed'?0:1;}else{pValue=1;} alphaValueEl.textContent=alphaLevel.toFixed(Math.max(3, alphaLevel.toString().split('.')[1]?.length||0)); zScoreEl.textContent=isFinite(zScore)?zScore.toFixed(3):(zScore>0?'+Infinity':'-Infinity'); pValueEl.textContent=isFinite(pValue)?pValue.toFixed(4):'N/A'; testTypeDisplayEl.textContent=testType==='two-tailed'?'Two-tailed':'One-tailed (B > A)'; const isSignificant=isFinite(pValue) && pValue<alphaLevel; significanceBadgeEl.classList.remove('success','error','na'); if(isSignificant){ significanceBadgeEl.textContent='Yes'; significanceBadgeEl.classList.add('badge','success'); sigInterpretationEl.textContent=`Result is statistically significant at α=${alphaLevel.toFixed(3)}.`; }else if(isFinite(pValue)){ significanceBadgeEl.textContent='No'; significanceBadgeEl.classList.add('badge','error'); sigInterpretationEl.textContent=`Result is NOT statistically significant at α=${alphaLevel.toFixed(3)}.`; }else{ significanceBadgeEl.textContent='N/A'; significanceBadgeEl.classList.add('badge','na'); sigInterpretationEl.textContent=`Significance could not be determined.`; } let probBbeatsA=NaN; probBbeatsAValueEl.textContent='Calculating...'; setTimeout(() => { const sim=20000; let bW=0; const aP=1,bP=1; const aAP=aP+conversionsA; const bAP=bP+(visitorsA-conversionsA); const aBP=aP+conversionsB; const bBP=bP+(visitorsB-conversionsB); try{ if(aAP<=0||bAP<=0||aBP<=0||bBP<=0)throw new Error("Invalid post params"); for(let i=0;i<sim;i++){ const sA=betaSample(aAP,bAP); const sB=betaSample(aBP,bBP); if(isNaN(sA)||isNaN(sB))continue; if(sB>sA)bW++; } probBbeatsA=sim>0?bW/sim:NaN; probBbeatsAValueEl.textContent=isFinite(probBbeatsA)?(probBbeatsA*100).toFixed(2)+'%':"Error"; if(isFinite(probBbeatsA))updateBetaChart(aAP,bAP,aBP,bBP); }catch(e){ console.error("Bayes sim err:", e); probBbeatsAValueEl.textContent="Error"; } finally{ const rD={visitorsA,conversionsA,visitorsB,conversionsB,crNumA,crNumB,alphaLevel,zScore,pValue,testType,isSignificant,probBbeatsA,timestamp:new Date().toISOString()}; generateInference(rD); saveTestToHistory(rD); resetCalculatorButton(); } }, 50); }
        function resetCalculatorButton() { calculateButton.disabled=false; calculateButton.innerHTML='<i class="fa-solid fa-calculator"></i> Run Analysis'; }
        // --- Charting Function ---
        function updateBetaChart(alphaA, betaA, alphaB, betaB) { chartErrorMsgEl.style.display='none'; if (!isFinite(alphaA)||!isFinite(betaA)||!isFinite(alphaB)||!isFinite(betaB)||alphaA<=0||betaA<=0||alphaB<=0||betaB<=0){console.error("Plot Error: Non-positive or non-finite alpha/beta parameters."); chartErrorMsgEl.textContent='Invalid alpha/beta values for chart.'; chartErrorMsgEl.style.display='block'; if(betaChartInstance){betaChartInstance.destroy();betaChartInstance=null;} return;} const pts=100;const L=[];const dA=[];const dB=[]; const mA=alphaA/(alphaA+betaA);const mB=alphaB/(alphaB+betaB); const vA=(alphaA*betaA)/(Math.pow(alphaA+betaA,2)*(alphaA+betaA+1)); const vB=(alphaB*betaB)/(Math.pow(alphaB+betaB,2)*(alphaB+betaB+1)); const sdA=isFinite(vA)&&vA>0?Math.sqrt(vA):0;const sdB=isFinite(vB)&&vB>0?Math.sqrt(vB):0; let minX=Math.min(mA-4*sdA,mB-4*sdB);let maxX=Math.max(mA+4*sdA,mB+4*sdB); if(!isFinite(minX)||!isFinite(maxX)||sdA===0||sdB===0||maxX-minX<1e-6){minX=Math.min(mA,mB)*0.8;maxX=Math.max(mA,mB)*1.2;} minX=Math.max(0,minX);maxX=Math.min(1,maxX); if(maxX<=minX){minX=0;maxX=1;} let maxD=0;let ptsGen=0; for(let i=0;i<=pts;i++){ const x=minX+(maxX-minX)*i/pts; if(!isFinite(x))continue; L.push(x);const dAv=betaPDF(x,alphaA,betaA);const dBv=betaPDF(x,alphaB,betaB); const fDA=isFinite(dAv)&&dAv>0?dAv:0;const fDB=isFinite(dBv)&&dBv>0?dBv:0; dA.push(fDA);dB.push(fDB); if(fDA>maxD)maxD=fDA; if(fDB>maxD)maxD=fDB; if(fDA>1e-6||fDB>1e-6)ptsGen++; } if(ptsGen===0){console.warn("No valid density points generated for chart"); chartErrorMsgEl.textContent='Could not generate valid chart data.'; chartErrorMsgEl.style.display='block'; if(betaChartInstance){betaChartInstance.destroy();betaChartInstance=null;} return;} const ctx=betaChartCanvas.getContext('2d');if(!ctx){console.error("Failed canvas context");return;} if(betaChartInstance){betaChartInstance.destroy();betaChartInstance=null;} try{betaChartInstance=new Chart(ctx,{type:'line',data:{labels:L,datasets:[{label:'Variant A',data:dA,borderColor:getComputedStyle(document.documentElement).getPropertyValue('--info-color'),backgroundColor:Chart.helpers.color(getComputedStyle(document.documentElement).getPropertyValue('--info-color')).alpha(0.3).rgbString(),borderWidth:2,fill:true,pointRadius:0,tension:0.4},{label:'Variant B',data:dB,borderColor:getComputedStyle(document.documentElement).getPropertyValue('--accent-color'),backgroundColor:Chart.helpers.color(getComputedStyle(document.documentElement).getPropertyValue('--accent-color')).alpha(0.3).rgbString(),borderWidth:2,fill:true,pointRadius:0,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{type:'linear',position:'bottom',title:{display:true,text:'Conversion Rate'},ticks:{callback:function(v){return (v*100).toFixed(1)+'%';}}},y:{beginAtZero:true,title:{display:true,text:'Density'},suggestedMax:maxD>1e-6?Math.ceil(maxD*1.2):5}},plugins:{legend:{position:'top'},tooltip:{callbacks:{label:function(c){let l=c.dataset.label||'';if(l){l+=': '}l+=`Rate: ${(c.parsed.x*100).toFixed(2)}%, Density: ${c.parsed.y.toFixed(2)}`;return l;}}}}}});}catch(e){console.error("Chart.js create failed:",e); chartErrorMsgEl.textContent='Chart library failed.'; chartErrorMsgEl.style.display='block'; if(betaChartInstance){betaChartInstance.destroy();betaChartInstance=null;}}}
        // --- Inference Generation (UPDATED TEXT CONTENT) ---
        function generateInference(results) {
            const { pValue, isSignificant, probBbeatsA, crNumA, crNumB, alphaLevel, testType } = results;
            let overallContent = '';
            let detailContent = ''; // This part will be rebuilt

            const pValueValid = typeof pValue === 'number' && !isNaN(pValue);
            const probBValid = typeof probBbeatsA === 'number' && !isNaN(probBbeatsA);
            const crADisplay = (crNumA * 100).toFixed(2);
            const crBDisplay = (crNumB * 100).toFixed(2);

             // 1. Generate Overall Conclusion Card (Logic remains the same)
             overallContent += `<div class="inference-summary-card">`;
            let recommendation = ""; let cardIcon = "fa-solid fa-lightbulb";
            if (!pValueValid || !probBValid) { recommendation=`<strong>Inconclusive (Calculation Error):</strong> Errors occurred during calculation (Frequentist: ${pValueValid?'OK':'Error'}, Bayesian: ${probBValid?'OK':'Error'}). Cannot draw a reliable conclusion.`; cardIcon="fa-solid fa-triangle-exclamation"; } else if (isSignificant && probBbeatsA > 0.95 && crNumB > crNumA) { recommendation=`<strong>Strong Consensus for B:</strong> Both methods strongly indicate Variant B (${crBDisplay}%) is superior to A (${crADisplay}%). High significance and Bayesian probability support implementation.`; cardIcon="fa-solid fa-rocket"; } else if (isSignificant && probBbeatsA < 0.05 && crNumA > crNumB) { recommendation=`<strong>Strong Consensus for A:</strong> Both methods strongly indicate Variant A (${crADisplay}%) is superior to B (${crBDisplay}%). Keep the original.`; cardIcon="fa-solid fa-shield-halved"; } else if (isSignificant && crNumB > crNumA) { recommendation=`<strong>Evidence Favors B:</strong> Statistical significance reached, favoring B (${crBDisplay}%). Even if Bayesian isn't extreme (${probBValid?(probBbeatsA*100).toFixed(1):'N/A'}% prob B>A), the significance provides strong grounds to choose B.`; cardIcon="fa-solid fa-arrow-trend-up"; } else if (isSignificant && crNumA > crNumB) { recommendation=`<strong>Evidence Favors A:</strong> Statistical significance reached, favoring A (${crADisplay}%). Bayesian shows P(B>A) is low (${probBValid?(probBbeatsA*100).toFixed(1):'N/A'}%). Keep Variant A.`; cardIcon="fa-solid fa-arrow-trend-down"; } else if (!isSignificant && probBValid && probBbeatsA > 0.90) { recommendation=`<strong>Bayesian Suggests B:</strong> Frequentist test inconclusive (p=${pValueValid?pValue.toFixed(3):'N/A'}), but Bayesian analysis strongly favors B (${(probBbeatsA*100).toFixed(1)}% prob B>A). Consider implementing B, accepting the higher uncertainty (risk) than if significant.`; cardIcon="fa-solid fa-compass"; } else if (!isSignificant && probBValid && probBbeatsA < 0.10) { recommendation=`<strong>Bayesian Suggests A:</strong> Frequentist test inconclusive (p=${pValueValid?pValue.toFixed(3):'N/A'}), and Bayesian analysis favors A (P(A>B) is ${probBValid?((1-probBbeatsA)*100).toFixed(1):'N/A'}%). Keep Variant A.`; cardIcon="fa-solid fa-circle-pause"; } else { recommendation=`<strong>Inconclusive:</strong> Neither method provides strong evidence. Difference is not significant (p=${pValueValid?pValue.toFixed(3):'N/A'}) and Bayesian probability (${probBValid?(probBbeatsA*100).toFixed(1):'N/A'}%) is indecisive. More data may be needed or keep Variant A.`; cardIcon="fa-solid fa-magnifying-glass"; }
            overallContent += `<h4><i class="${cardIcon}"></i> Overall Recommendation</h4><p>${recommendation}</p></div>`;

            // 2. Generate Detailed Explanations (Using phrasing from screenshot)
            detailContent += `<div class="inference-details">`; // Wrap details
            detailContent += `<h4>Understanding the Frequentist Results</h4>`;
            const testTypeName = testType === 'two-tailed' ? 'Two-tailed' : 'One-tailed (B>A)';
            detailContent += `<p>The Frequentist Z-Test (${testTypeName}) assumes initially ("null hypothesis" <span class="math">H₀</span>) that both variants have the same true conversion rate. The goal is to see if your data provides enough evidence to reject this assumption.`;
            if (pValueValid) { const pValueFormatted = pValue.toFixed(4); const alphaFormatted = alphaLevel.toFixed(3); detailContent += ` We calculated a <span class="math">p-value = ${pValueFormatted}</span>. This is the chance of seeing a difference like yours (or more extreme) *if H₀ were true*.`; detailContent += ` We compare this to your chosen significance level <span class="math">α = ${alphaFormatted}</span>.`; if (isSignificant) { detailContent += ` Since <span class="math">p < α</span>, we <strong>reject H₀</strong>, concluding the difference is statistically significant.</p>`; } else { detailContent += ` Since <span class="math">p ≥ α</span>, we <strong>fail to reject H₀</strong>. The data doesn't provide strong enough evidence (at this level) to say the rates are truly different.</p>`; } } else { detailContent += ` The p-value calculation encountered an issue.</p>`; }
            detailContent += `<h4>Understanding the Bayesian Results</h4>`;
            detailContent += `<p>The Bayesian approach uses your data to update beliefs about the conversion rates, visualized as posterior distributions (see chart). We started with a neutral <span class="math">Beta(1, 1)</span> prior.`;
            if (probBValid) { const probFormatted = (probBbeatsA * 100).toFixed(2); detailContent += ` Based on the updated beliefs, the probability that Variant B's true rate is higher than Variant A's is <span class="math">P(B > A) = ${probFormatted}%</span>. This directly estimates the chance B is better. A high value suggests confidence in B; a low value suggests confidence in A.</p>`; } else { detailContent += ` The Bayesian probability could not be calculated due to an error.</p>`; }
            detailContent += `</div>`;

            // Combine in correct order
             inferenceTextEl.innerHTML = overallContent + detailContent;
         }
        // --- History Management ---
        const HISTORY_KEY='abTestHistory'; function getHistory(){ try{return JSON.parse(localStorage.getItem(HISTORY_KEY))||[];}catch{return[];}} function saveTestToHistory(r){ const h=getHistory(); h.unshift(r); if(h.length>10)h.length=10; try{localStorage.setItem(HISTORY_KEY,JSON.stringify(h));}catch(e){console.error("LS save err",e);} renderHistory(); } function renderHistory(){ const h=getHistory(); recentTestsList.innerHTML=''; if(h.length === 0){noHistoryMsg.style.display='block';return;} noHistoryMsg.style.display='none'; h.forEach((item,idx) => { const li=document.createElement('li'); const rN=h.length-idx; const dt=new Date(item.timestamp); const fD=dt.toLocaleDateString()+' '+dt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); const pB=(typeof item.probBbeatsA==='number'&&!isNaN(item.probBbeatsA))?`${(item.probBbeatsA*100).toFixed(1)}%`:'N/A'; const pV=(typeof item.pValue==='number'&&!isNaN(item.pValue))?`p:${item.pValue.toFixed(3)}`:'p:N/A'; const vA=item.visitorsA??'?'; const cA=item.conversionsA??'?'; const vB=item.visitorsB??'?'; const cB=item.conversionsB??'?'; const ttL=item.testType==='two-tailed'?'2-tail':'1-tail(B>A)'; li.innerHTML=`<div class="history-item-header"><strong>Run #${rN}</strong> <span style="font-size:0.8em;opacity:0.7;">(${fD})</span></div> <div class="history-item-details"><span>Bayes P(B>A):${pB}</span>|<span class="test-type">${ttL}</span> ${pV}</div> <div class="history-item-inputs">A:${cA}/${vA}|B:${cB}/${vB}</div>`; recentTestsList.appendChild(li); }); } function clearHistory(){if(confirm("Clear history?")){localStorage.removeItem(HISTORY_KEY); renderHistory();}}
        // --- Theme Management ---
        const THEME_KEY='abTestTheme'; function applyTheme(t){if(t==='dark'){document.body.classList.add('dark-mode');themeToggleButton.innerHTML='<i class="fa-solid fa-sun"></i> Light Mode';}else{document.body.classList.remove('dark-mode');themeToggleButton.innerHTML='<i class="fa-solid fa-moon"></i> Dark Mode';} if(betaChartInstance){/* Might need redraw if colors change */} } function toggleTheme(){const c=document.body.classList.contains('dark-mode')?'dark':'light';const n=c==='dark'?'light':'dark';localStorage.setItem(THEME_KEY,n);applyTheme(n);} function loadInitialTheme(){const s=localStorage.getItem(THEME_KEY)||'light';applyTheme(s);}
        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', ()=>{calculateButton.addEventListener('click',runAnalysis);clearHistoryButton.addEventListener('click',clearHistory);themeToggleButton.addEventListener('click',toggleTheme);loadInitialTheme();renderHistory(); /* Optional: runAnalysis(); */ });
    </script>
</body>
</html>
